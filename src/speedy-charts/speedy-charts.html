<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/highcharts-chart/highcharts-chart.html">
<script src="https://www.gstatic.com/firebasejs/3.6.6/firebase.js"></script>

<!--
`speedy-charts`
Conatiner for chart components

@demo demo/index.html
-->

<dom-module id="speedy-charts">
  <template>
    <style>
      :host {
        display: block;

      }
      paper-material {
        background-color: #fff;
      }
      #bw{
        color: #EF4136;
      }
      #lt {
        margin-top: 20px;
        color: #EF4136;
      }
      #ltp {
        color: #EF4136;
        margin-top: 20px;
      }
    </style>

      <paper-material elevation="2">
        <highcharts-chart
          id="bw"
          type="spline"
          label="MBPS"
          data="[[speeds]]"
          title="Bandwidth"
          x-zoom
          x-label="Time"
          y-label="MBPS"
          loading
          loading-message="Countdown to boom time!"
          vs-time
          export>
        </highcharts-chart>
      </paper-material>

      <paper-material id="ltp" elevation="2">
        <highcharts-chart
          id="lt"
          type="spline"
          data="[[latencies]]"
          title="Latency"
          x-zoom
          x-label="Time"
          y-label="ms"
          loading
          loading-message="Countdown to boom time!"
          vs-time
          export>
        </highcharts-chart>
      </paper-material>

  </template>

  <script>
    Polymer({
      is: 'speedy-charts',
      ready: function() {
        var self = this;

        // database config
        var config = {
          apiKey: 'AIzaSyDKpxmykTkOS26PlbfIYXQoJAJmBSLQh0Y',
          authDomain: 'speedy-f57c3.firebaseapp.com',
          databaseURL: 'https://speedy-f57c3.firebaseio.com',
        };

        // initialize firebase and get a ref to the db service
        firebase.initializeApp(config);
        var db = firebase.database()

        //query the tests location and listen for changes. Call the testDataUpdated
        //function to process the data
        db.ref('tests/').limitToLast(96).on('value',function(snap){
          self.testDataUpdated(snap)
        })
      },
      properties: {
        speeds: {
          type: Array,
        },
        latencies: {
          type: Array,
          value: [],
        },
      },
        testDataUpdated: function(snap) {
          // set the loading message
          this.$.bw.loading = true;
          this.$.lt.loading = true;

          // get a reference to this for use inside functions
          var self = this;

          // clear the arrays for new payload
          this.set('speeds', []);
          this.set('latencies', []);

          //iterate ove the snapshot and parse data into speeds and latencies arrays
          snap.forEach(function(el) {
            var speed = [Number(el.key), el.val().speeds.download];
            var latency = [Number(el.key), el.val().server.ping]
            self.push('speeds', speed);
            self.push('latencies', latency)
          });

          //re-render the charts and clear the loading message
          this.$.bw.reRender();
          this.$.lt.reRender();
          this.$.bw.loading = false;
          this.$.lt.loading = false;
        },
    });
  </script>
</dom-module>
